name: Sovereignty Check

on:
  pull_request:
  push:
    branches: [main]

jobs:
  sovereignty-check:
    runs-on: ubuntu-latest
    name: Verify Docker-only deployment

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Block Vercel/Supabase reintroduction (workflows + artifacts)
        shell: bash
        run: |
          set -euo pipefail

          echo "üîç Scanning for sovereignty violations..."
          echo ""

          # Ensure ripgrep exists (usually preinstalled on ubuntu-latest, but guard anyway)
          if ! command -v rg >/dev/null 2>&1; then
            echo "Installing ripgrep..."
            sudo apt-get update
            sudo apt-get install -y ripgrep
          fi

          # 1) Block references in workflows
          echo "1) Checking workflows..."
          if rg -n -i "vercel|supabase|VERCEL_|SUPABASE_" .github/workflows; then
            echo ""
            echo "‚ùå SOVEREIGNTY VIOLATION: Vercel/Supabase detected in workflows."
            exit 1
          fi
          echo "‚úì Workflows clean."
          echo ""

          # 2) Block common repo artifacts
          echo "2) Checking for forbidden artifacts..."
          bad_paths=(
            ".vercel"
            "vercel.json"
            ".vercelignore"
            "_vercelignore"
            ".vercel-build-trigger"
            "supabase"
          )

          violations=()
          for p in "${bad_paths[@]}"; do
            if [[ -e "$p" ]]; then
              violations+=("$p")
            fi
          done

          if (( ${#violations[@]} )); then
            echo ""
            echo "‚ùå SOVEREIGNTY VIOLATION: forbidden artifact(s) found:"
            printf ' - %s\n' "${violations[@]}"
            exit 1
          fi

          echo "‚úì No forbidden artifacts found."
          echo ""
          echo "‚úÖ Sovereignty check passed."
