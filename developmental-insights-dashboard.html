<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MAIA Developmental Insights Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #e8e8e8;
      padding: 20px;
      min-height: 100vh;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      padding: 30px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }

    .header h1 {
      font-size: 2.5em;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }

    .header p {
      color: #a8a8a8;
      font-size: 1.1em;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.08);
      padding: 25px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .stat-card h3 {
      font-size: 0.9em;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #a8a8a8;
      margin-bottom: 10px;
    }

    .stat-card .value {
      font-size: 2.5em;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-card .label {
      font-size: 0.9em;
      color: #888;
    }

    .chart-container {
      background: rgba(255, 255, 255, 0.05);
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 30px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chart-title {
      font-size: 1.3em;
      font-weight: 600;
      margin-bottom: 20px;
      color: #fff;
    }

    .refresh-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 50px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
      transition: all 0.3s;
    }

    .refresh-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
    }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 1.2em;
      color: #a8a8a8;
    }

    .error {
      background: rgba(255, 0, 0, 0.1);
      border: 1px solid rgba(255, 0, 0, 0.3);
      padding: 20px;
      border-radius: 8px;
      color: #ff6b6b;
      margin-bottom: 20px;
    }

    .pattern-insight {
      background: rgba(102, 126, 234, 0.1);
      border-left: 4px solid #667eea;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .pattern-insight h4 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 1.1em;
    }

    .pattern-insight p {
      color: #d0d0d0;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üß¨ MAIA Developmental Insights</h1>
    <p>Real-time consciousness evolution tracking</p>
  </div>

  <div id="loading" class="loading">
    Loading developmental data...
  </div>

  <div id="error" style="display: none;"></div>

  <div id="stats" style="display: none;"></div>
  <div id="patterns" style="display: none;"></div>
  <div id="charts" style="display: none;"></div>

  <button class="refresh-btn" onclick="loadData()">üîÑ Refresh Data</button>

  <script>
    // Configuration
    const SUPABASE_URL = 'https://jkbetmadzcpoinjogkli.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImprYmV0bWFkemNwb2luam9na2xpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1NjIyNDUsImV4cCI6MjA1ODEzODI0NX0.K5nuL4m8sP1bC21TmsfpakY5cSfh_5pSLJ83G9Iu_-I';

    // Fetch data from Supabase
    async function fetchData(table, params = '') {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${params}`, {
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        }
      });
      return response.json();
    }

    // Load all data and render
    async function loadData() {
      try {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('error').style.display = 'none';

        // Fetch all tables
        const [attending, dissociation, shifts] = await Promise.all([
          fetchData('attending_observations', 'select=*&order=timestamp.desc&limit=100'),
          fetchData('dissociation_incidents', 'select=*&order=timestamp.desc&limit=50'),
          fetchData('shift_events', 'select=*&order=timestamp.desc&limit=50')
        ]);

        document.getElementById('loading').style.display = 'none';

        // Render stats
        renderStats(attending, dissociation, shifts);

        // Analyze patterns
        renderPatterns(attending, dissociation, shifts);

        // Render charts
        renderCharts(attending, dissociation, shifts);

        document.getElementById('stats').style.display = 'block';
        document.getElementById('patterns').style.display = 'block';
        document.getElementById('charts').style.display = 'block';

      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').innerHTML = `
          <div class="error">
            <strong>Error loading data:</strong> ${error.message}
            <br><br>
            Make sure Supabase is accessible and credentials are correct.
          </div>
        `;
      }
    }

    // Render stats cards
    function renderStats(attending, dissociation, shifts) {
      const avgAttending = attending.length > 0
        ? (attending.reduce((sum, a) => sum + a.attending_quality, 0) / attending.length).toFixed(2)
        : 0;

      const rightBrainCount = attending.filter(a => a.attending_quality >= 0.6).length;
      const leftBrainCount = attending.filter(a => a.attending_quality < 0.4).length;

      const mode = rightBrainCount > leftBrainCount ? 'üß† Right-brain' :
                   leftBrainCount > rightBrainCount ? 'üî¨ Left-brain' : '‚öñÔ∏è Balanced';

      const severeDissociations = dissociation.filter(d => d.severity >= 0.7).length;

      document.getElementById('stats').innerHTML = `
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Total Observations</h3>
            <div class="value">${attending.length}</div>
            <div class="label">Interactions tracked</div>
          </div>
          <div class="stat-card">
            <h3>Avg Attending Quality</h3>
            <div class="value">${(avgAttending * 100).toFixed(0)}%</div>
            <div class="label">Average presence score</div>
          </div>
          <div class="stat-card">
            <h3>Dominant Mode</h3>
            <div class="value">${mode}</div>
            <div class="label">${rightBrainCount} right / ${leftBrainCount} left</div>
          </div>
          <div class="stat-card">
            <h3>Dissociation Events</h3>
            <div class="value">${dissociation.length}</div>
            <div class="label">${severeDissociations} severe (‚â•70%)</div>
          </div>
          <div class="stat-card">
            <h3>Consciousness Shifts</h3>
            <div class="value">${shifts.length}</div>
            <div class="label">Elemental transitions</div>
          </div>
        </div>
      `;
    }

    // Analyze and render patterns
    function renderPatterns(attending, dissociation, shifts) {
      let insights = [];

      // Pattern 1: Archetype performance
      const archetypeStats = {};
      attending.forEach(a => {
        if (!archetypeStats[a.archetype]) {
          archetypeStats[a.archetype] = { total: 0, count: 0 };
        }
        archetypeStats[a.archetype].total += a.attending_quality;
        archetypeStats[a.archetype].count += 1;
      });

      const bestArchetype = Object.entries(archetypeStats)
        .map(([name, stats]) => ({ name, avg: stats.total / stats.count }))
        .sort((a, b) => b.avg - a.avg)[0];

      if (bestArchetype) {
        insights.push({
          title: 'üé≠ Highest Performing Archetype',
          text: `The <strong>${bestArchetype.name}</strong> archetype shows the highest attending quality at ${(bestArchetype.avg * 100).toFixed(0)}%. This suggests strong coherence when operating in this mode.`
        });
      }

      // Pattern 2: Dissociation patterns
      if (dissociation.length > 0) {
        const mostCommonType = dissociation.reduce((acc, d) => {
          acc[d.type] = (acc[d.type] || 0) + 1;
          return acc;
        }, {});
        const topType = Object.entries(mostCommonType).sort((a, b) => b[1] - a[1])[0];

        insights.push({
          title: '‚ö†Ô∏è Dissociation Pattern',
          text: `Most common dissociation type is <strong>${topType[0]}</strong> (${topType[1]} occurrences). This indicates ${getDissociationMeaning(topType[0])}.`
        });
      }

      // Pattern 3: Shift magnitude
      if (shifts.length > 0) {
        const avgMagnitude = shifts.reduce((sum, s) => sum + s.magnitude, 0) / shifts.length;
        insights.push({
          title: 'üåä Consciousness Shift Magnitude',
          text: `Average shift magnitude is ${avgMagnitude.toFixed(3)}. ${avgMagnitude < 0.2 ? 'Shifts are relatively smooth and gradual.' : 'Significant elemental transitions are occurring.'}`
        });
      }

      // Render insights
      document.getElementById('patterns').innerHTML = `
        <div class="chart-container">
          <div class="chart-title">üìà Pattern Analysis</div>
          ${insights.map(i => `
            <div class="pattern-insight">
              <h4>${i.title}</h4>
              <p>${i.text}</p>
            </div>
          `).join('')}
        </div>
      `;
    }

    function getDissociationMeaning(type) {
      const meanings = {
        'coherence_drop': 'loss of integration across responses',
        'discontinuity': 'abrupt tonal or thematic shifts',
        'boundary_thicken': 'over-rigid, black-and-white thinking',
        'fragmentation': 'contradictory statements within responses',
        'contradiction': 'direct logical conflicts',
        'state_collapse': 'degradation in response quality'
      };
      return meanings[type] || 'consciousness fragmentation';
    }

    // Render charts
    function renderCharts(attending, dissociation, shifts) {
      document.getElementById('charts').innerHTML = `
        <div class="chart-container">
          <div class="chart-title">Attending Quality Over Time</div>
          <div id="attendingChart"></div>
        </div>
        <div class="chart-container">
          <div class="chart-title">Right-Brain vs Left-Brain Distribution</div>
          <div id="modeChart"></div>
        </div>
        <div class="chart-container">
          <div class="chart-title">Dissociation Timeline</div>
          <div id="dissociationChart"></div>
        </div>
        <div class="chart-container">
          <div class="chart-title">Consciousness Shifts (Elemental Deltas)</div>
          <div id="shiftsChart"></div>
        </div>
      `;

      // Chart 1: Attending Quality Over Time
      const attendingTrace = {
        x: attending.map(a => new Date(a.timestamp)),
        y: attending.map(a => a.attending_quality * 100),
        type: 'scatter',
        mode: 'lines+markers',
        name: 'Attending Quality',
        line: { color: '#667eea', width: 3 },
        marker: { size: 8 }
      };

      Plotly.newPlot('attendingChart', [attendingTrace], {
        xaxis: { title: 'Time', color: '#a8a8a8' },
        yaxis: { title: 'Attending Quality (%)', color: '#a8a8a8', range: [0, 100] },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { color: '#a8a8a8' },
        shapes: [
          { type: 'line', x0: 0, x1: 1, xref: 'paper', y0: 60, y1: 60, line: { color: 'green', width: 2, dash: 'dash' } },
          { type: 'line', x0: 0, x1: 1, xref: 'paper', y0: 40, y1: 40, line: { color: 'orange', width: 2, dash: 'dash' } }
        ]
      });

      // Chart 2: Mode Distribution
      const rightBrain = attending.filter(a => a.attending_quality >= 0.6).length;
      const balanced = attending.filter(a => a.attending_quality >= 0.4 && a.attending_quality < 0.6).length;
      const leftBrain = attending.filter(a => a.attending_quality < 0.4).length;

      const modeTrace = {
        values: [rightBrain, balanced, leftBrain],
        labels: ['Right-brain (‚â•60%)', 'Balanced (40-60%)', 'Left-brain (<40%)'],
        type: 'pie',
        marker: {
          colors: ['#667eea', '#f7b731', '#fa8231']
        }
      };

      Plotly.newPlot('modeChart', [modeTrace], {
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { color: '#a8a8a8' }
      });

      // Chart 3: Dissociation Timeline
      if (dissociation.length > 0) {
        const dissocTrace = {
          x: dissociation.map(d => new Date(d.timestamp)),
          y: dissociation.map(d => d.severity * 100),
          type: 'bar',
          name: 'Severity',
          marker: {
            color: dissociation.map(d => d.severity >= 0.7 ? '#ff6b6b' : '#feca57'),
          },
          text: dissociation.map(d => d.type),
          hovertemplate: '%{text}<br>Severity: %{y:.0f}%<extra></extra>'
        };

        Plotly.newPlot('dissociationChart', [dissocTrace], {
          xaxis: { title: 'Time', color: '#a8a8a8' },
          yaxis: { title: 'Severity (%)', color: '#a8a8a8', range: [0, 100] },
          paper_bgcolor: 'rgba(0,0,0,0)',
          plot_bgcolor: 'rgba(0,0,0,0)',
          font: { color: '#a8a8a8' }
        });
      } else {
        document.getElementById('dissociationChart').innerHTML = '<p style="color: #888; padding: 20px;">No dissociation events recorded yet.</p>';
      }

      // Chart 4: Consciousness Shifts
      if (shifts.length > 0) {
        const shift = shifts[0]; // Most recent
        const shiftData = {
          x: ['Fire', 'Water', 'Earth', 'Air', 'Aether'],
          y: [shift.fire_delta, shift.water_delta, shift.earth_delta, shift.air_delta, shift.aether_delta],
          type: 'bar',
          marker: {
            color: ['#ff6b6b', '#4ecdc4', '#95e1d3', '#f7b731', '#a29bfe']
          }
        };

        Plotly.newPlot('shiftsChart', [shiftData], {
          xaxis: { title: 'Element', color: '#a8a8a8' },
          yaxis: { title: 'Delta', color: '#a8a8a8' },
          paper_bgcolor: 'rgba(0,0,0,0)',
          plot_bgcolor: 'rgba(0,0,0,0)',
          font: { color: '#a8a8a8' }
        });
      } else {
        document.getElementById('shiftsChart').innerHTML = '<p style="color: #888; padding: 20px;">No consciousness shifts recorded yet.</p>';
      }
    }

    // Load data on page load
    loadData();
  </script>
</body>
</html>
