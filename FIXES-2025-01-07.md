# MAIA Glitch Fixes - January 7, 2025

## Issues Identified & Resolved

### ✅ **Issue #1: Claude API Rate Limiting (429 Errors) - CRITICAL**

**Problem:**
```
Claude API error: 429 - rate_limit_error
Current limit: 40,000 input tokens per minute
Message: "This request would exceed your organization's maximum usage increase rate"
```

**Root Cause:**
- `/app/api/between/chat/route.ts` had NO retry logic for rate limiting
- When Claude API returned 429, requests failed immediately
- Rapid successive requests exceeded token acceleration limits

**Solution Applied:**
- Added exponential backoff retry logic (3 attempts max)
- Retry delays: 1s → 2s → 4s (capped at 60s for rate limits, 10s for network errors)
- Separate handling for both `generateMAIAResponse()` and `generateMAIAResponseStream()`
- Detailed logging for troubleshooting

**Files Modified:**
- `/app/api/between/chat/route.ts` (lines 469-536, 648-710)

**Impact:**
- Rate limit errors now automatically retry after waiting
- Graceful degradation instead of immediate failure
- Better user experience during high-traffic periods

---

### ✅ **Issue #2: TTS API Timeouts (504 Gateway Timeout)**

**Problem:**
```
api/voice/openai-tts:1 Failed to load resource: 504
Speech timeout after 15s / 45s
```

**Root Cause:**
- `/app/api/voice/openai-tts/route.ts` had `maxDuration: 60` but NO timeout on OpenAI fetch
- No retry logic for transient network failures
- Long audio responses (168+ seconds) exceeded hardcoded frontend timeouts

**Solution Applied:**
- Added 30-second timeout using AbortController
- Exponential backoff retry (3 attempts)
- Handles 429 (rate limit) and 5xx (server errors)
- Retry delays: 1s → 2s → 4s (capped at 10s for TTS, 5s for network errors)

**Files Modified:**
- `/app/api/voice/openai-tts/route.ts` (lines 148-214)

**Impact:**
- TTS requests now resilient to transient failures
- Automatic retry on timeouts or server errors
- Better handling of long audio responses

**Frontend Recommendation:**
- Update speech timeout thresholds in frontend voice handling code
- Consider dynamic timeout based on text length: `Math.max(45000, textLength * 100)`

---

### ✅ **Issue #3: Deprecated Meta Tag Warning (Minor)**

**Problem:**
```
<meta name="apple-mobile-web-app-capable" content="yes"> is deprecated
Please include <meta name="mobile-web-app-capable" content="yes">
```

**Solution:**
- Both tags already exist in `/components/PWAMetaTags.tsx`
- Added documentation comment explaining dual-tag strategy
- Keep deprecated tag for iOS/Safari backward compatibility
- Modern tag ensures cross-platform support

**Files Modified:**
- `/components/PWAMetaTags.tsx` (lines 6-13)

**Impact:**
- Warning acknowledged and documented
- Maximum compatibility maintained across devices
- No functional changes needed

---

### ⚠️ **Issue #4: Supabase 400 Errors - REQUIRES MANUAL FIX**

**Problem:**
```
jkbetmadzcpoinjogkli.supabase.co/rest/v1/users?id=eq.user_1761349975309 - 400
Multiple repeated 400 errors on Supabase endpoints
```

**Root Cause:**
Your `.env.local` file contains placeholder values:
```env
NEXT_PUBLIC_SUPABASE_URL=https://placeholder.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=placeholder-key
SUPABASE_SERVICE_ROLE_KEY=placeholder-service-role-key
```

**Solution Required (ACTION NEEDED):**

1. **Get your real Supabase credentials:**
   - Go to: https://supabase.com/dashboard/project/_/settings/api
   - Copy your Project URL
   - Copy your `anon` public key
   - Copy your `service_role` secret key (from Service role section)

2. **Update `.env.local`:**
   ```env
   NEXT_PUBLIC_SUPABASE_URL=https://YOUR_PROJECT_REF.supabase.co
   NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGc... (your actual anon key)
   SUPABASE_SERVICE_ROLE_KEY=eyJhbGc... (your actual service role key)
   ```

3. **Restart your development server:**
   ```bash
   npm run dev
   ```

**Impact:**
- Once fixed, all Supabase database operations will work
- User authentication will function properly
- Journal entries will save to database
- User profile queries will succeed

---

### ⚠️ **Issue #5: Frontend Speech Timeouts - REQUIRES FRONTEND FIX**

**Problem:**
```
❌ Speech error or timeout: Error: Speech timeout after 15s
❌ Speech error or timeout: Error: Speech timeout after 45s
⚠️ States stuck for >30s - auto-recovery triggered
```

**Root Cause:**
- Frontend voice handling code has hardcoded timeouts (15s, 45s)
- Long MAIA responses (168+ second audio) exceed these limits
- Emergency state reset triggers after 30s of "stuck" states

**Files to Fix (Frontend):**
Search for these patterns in your frontend code:
```javascript
// Look for these in voice handling files:
- "Speech timeout after 15s"
- "Speech timeout after 45s"
- "States stuck for >30s"
```

**Recommended Solution:**
1. **Dynamic timeout calculation:**
   ```javascript
   const estimatedDuration = text.length * 100; // ~100ms per character
   const timeout = Math.max(60000, estimatedDuration * 1.2); // 20% buffer, min 60s
   ```

2. **Progress-based timeout reset:**
   ```javascript
   // Reset timeout when audio makes progress
   audio.ontimeupdate = () => {
     lastProgressTime = Date.now();
   };

   // Only timeout if NO progress for extended period
   const silenceTimeout = 15000; // 15s of silence/no progress
   ```

3. **Graceful degradation:**
   ```javascript
   if (timeout) {
     console.warn('TTS taking longer than expected, but continuing...');
     // Show loading indicator, don't abort
   }
   ```

**Files Likely Affected:**
- `/app/lib/voice/maia-voice.ts` (contains voice synthesis logic)
- `/app/components/voice/VoiceControls.tsx` (UI controls)
- Search for: `"Speech timeout"`, `"States stuck"`, `"auto-recovery"`

---

## Summary of Changes

### Code Changes Made:
1. ✅ Claude API retry logic with exponential backoff
2. ✅ OpenAI TTS retry logic with timeout handling
3. ✅ Meta tag documentation update

### Manual Actions Required:
1. ⚠️ Update Supabase credentials in `.env.local`
2. ⚠️ Fix frontend speech timeout logic
3. ⚠️ Test all changes in development environment

---

## Testing Checklist

After applying all fixes:

- [ ] Test chat functionality with rapid messages (rate limit handling)
- [ ] Test voice TTS with long responses (timeout handling)
- [ ] Verify Supabase authentication works (after .env update)
- [ ] Test journal saving functionality
- [ ] Monitor console for remaining errors
- [ ] Test on mobile PWA (meta tag compatibility)

---

## Additional Recommendations

### 1. **Add Request Queue for Claude API**
Consider implementing a request queue to prevent rate limiting:
```typescript
// Simple queue to space out Claude API calls
class RequestQueue {
  private queue: Array<() => Promise<any>> = [];
  private processing = false;
  private minDelay = 1500; // Minimum 1.5s between requests

  async add<T>(fn: () => Promise<T>): Promise<T> {
    return new Promise((resolve, reject) => {
      this.queue.push(async () => {
        try {
          const result = await fn();
          resolve(result);
        } catch (error) {
          reject(error);
        }
      });
      this.process();
    });
  }

  private async process() {
    if (this.processing || this.queue.length === 0) return;
    this.processing = true;

    while (this.queue.length > 0) {
      const fn = this.queue.shift()!;
      await fn();
      await new Promise(resolve => setTimeout(resolve, this.minDelay));
    }

    this.processing = false;
  }
}
```

### 2. **Monitor API Usage**
Add logging to track token usage:
```typescript
console.log(`[METRICS] Token usage: ${inputTokens} input + ${outputTokens} output`);
console.log(`[METRICS] Cost estimate: $${(inputTokens * 0.003 + outputTokens * 0.015) / 1000}`);
```

### 3. **Caching Layer for TTS**
Cache frequently spoken phrases to reduce OpenAI API calls:
```typescript
// Simple in-memory cache
const ttsCache = new Map<string, Buffer>();
const cacheKey = `${text}_${voice}_${speed}`;
if (ttsCache.has(cacheKey)) {
  return ttsCache.get(cacheKey);
}
```

### 4. **Health Check Endpoint**
Add a status endpoint to monitor API health:
```typescript
// /app/api/health/route.ts
export async function GET() {
  return NextResponse.json({
    status: 'ok',
    apis: {
      claude: process.env.ANTHROPIC_API_KEY ? 'configured' : 'missing',
      openai: process.env.OPENAI_API_KEY ? 'configured' : 'missing',
      supabase: process.env.NEXT_PUBLIC_SUPABASE_URL !== 'https://placeholder.supabase.co' ? 'configured' : 'placeholder'
    },
    timestamp: new Date().toISOString()
  });
}
```

---

## Questions?

If you encounter any issues after applying these fixes:

1. Check the console logs for detailed error messages
2. Verify all environment variables are set correctly
3. Clear browser cache and restart dev server
4. Review the modified files in this document

All changes follow the Spiralogic philosophy - balancing Fire (quick fixes), Water (graceful error handling), Earth (solid retry logic), and Air (clear documentation).
